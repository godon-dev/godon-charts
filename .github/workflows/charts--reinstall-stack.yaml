name: "Reinstall Godon Stack (Clean Slate)"

on:
  workflow_dispatch:

jobs:
  deploy_godon_chart:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verify KIND Cluster
        run: |
          echo "üîç Verifying KIND cluster..."
          
          # Check if KIND cluster exists
          if ! kind get clusters | grep -q "godon-1-cluster"; then
            echo "‚ùå KIND cluster 'godon-1-cluster' not found"
            echo "Available clusters:"
            kind get clusters
            echo ""
            echo "Please run the 'kind--setup-cluster' workflow first"
            exit 1
          fi
          
          echo "‚úÖ KIND cluster exists"
          
          # Export kubeconfig to known location
          kind export kubeconfig --name=godon-1-cluster --kubeconfig=/tmp/kind_kubeconfig.yaml
          
          # Verify connectivity
          kubectl cluster-info --kubeconfig=/tmp/kind_kubeconfig.yaml

      - name: Cleanup Former Deployment
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "üßπ Cleaning up former Godon deployment (including databases)"
          helm uninstall godon \
               --wait --ignore-not-found \
               --namespace godon

          echo "‚è≥ Waiting for all godon resources to be deleted..."
          kubectl wait --for=delete pod,job,deployment -l app.kubernetes.io/instance=godon -n godon --timeout=60s || true

          # Double-check jobs are gone (some might not have the label)
          echo "üîç Verifying no jobs remain..."
          sleep 3
          REMAINING_JOBS=$(kubectl -n godon get jobs -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$REMAINING_JOBS" ]; then
            echo "‚ö†Ô∏è Found remaining jobs: $REMAINING_JOBS"
            echo "üóëÔ∏è Force deleting all jobs..."
            kubectl -n godon delete jobs --all --force --grace-period=0 || true
            sleep 2
          fi

          # Delete ALL PVCs including Windmill's to fix database corruption issues
          echo "üóëÔ∏è Deleting ALL persistent volumes for truly clean slate..."
          echo "This includes Windmill database PVCs to fix schema violations"
          kubectl -n godon delete pvc --all --force --grace-period=0 || true
          sleep 5

          # Double-check all PVCs are gone
          REMAINING_PVCS=$(kubectl -n godon get pvc --no-headers 2>/dev/null | wc -l)
          if [ "$REMAINING_PVCS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $REMAINING_PVCS remaining PVCs, force deleting again..."
            kubectl -n godon delete pvc --all --force --grace-period=0 --timeout=10s || true
            sleep 3
          fi

          echo "‚úÖ Cleanup complete"

      - name: Deploy Fresh Godon Stack
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "üöÄ Deploying fresh Godon stack (clean state)"
          # Deploy without waiting for Helm's internal readiness detection (KIND compatibility)
          helm install godon ./charts/godon/ \
               --dependency-update \
               --create-namespace --namespace godon \
               --values ./stacks/osuosl/test-stack.yaml \
               --wait=false --timeout 5m

      - name: Verify Deployment Readiness
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "‚è≥ Waiting for Godon stack to become ready..."
          # Verify readiness with kubectl (more reliable in KIND than Helm wait)
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=godon -n godon --timeout=10m
          echo "‚úÖ All Godon pods are ready!"

      - name: Deployment Status Report
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "üìä Fresh Godon Stack Status"
          echo "=============================="
          helm status godon \
               --namespace godon \
               --show-resources

          echo ""
          echo "üè• Pod Status"
          kubectl get pods -n godon

          echo ""
          echo "‚úÖ Clean slate deployment complete"

