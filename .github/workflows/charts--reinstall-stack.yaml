name: "Reinstall Godon Stack (Clean Slate)"

on:
  workflow_dispatch:

jobs:
  deploy_godon_chart:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Cleanup Former Deployment
        run: |
          echo "üßπ Cleaning up former Godon deployment (including databases)"
          helm uninstall godon \
               --kubeconfig /run/kind_kubeconfig.yaml \
               --wait --ignore-not-found \
               --namespace godon

      - name: Deploy Fresh Godon Stack
        run: |
          echo "üöÄ Deploying fresh Godon stack (clean state)"
          helm install godon ./charts/godon/ \
               --kubeconfig /run/kind_kubeconfig.yaml \
               --dependency-update \
               --create-namespace --namespace godon \
               --values ./charts/godon/osuosl_deploy_values.yml \
               --wait --timeout 20m

      - name: Deployment Status Report
        run: |
          echo "üìä Fresh Godon Stack Status"
          echo "=============================="
          helm status godon \
               --kubeconfig /run/kind_kubeconfig.yaml \
               --namespace godon \
               --show-resources

          echo ""
          echo "üè• Pod Status"
          kubectl get pods -n godon --kubeconfig /run/kind_kubeconfig.yaml

          echo ""
          echo "‚úÖ Clean slate deployment complete"

