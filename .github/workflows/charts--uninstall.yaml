name: "Uninstall Godon Chart"

on:
  workflow_dispatch:
    inputs:
      keep_namespace:
        description: 'Keep the namespace after uninstalling'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  uninstall-chart:
    name: Uninstall Godon from KIND
    runs-on: [self-hosted, linux]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 1

    - name: Verify KIND Cluster
      run: |
        echo "üîç Verifying KIND cluster..."

        if ! kind get clusters | grep -q "godon-1-cluster"; then
          echo "‚ùå KIND cluster 'godon-1-cluster' not found"
          echo "Available clusters:"
          kind get clusters
          exit 1
        fi

        echo "‚úÖ KIND cluster exists"
        kind export kubeconfig --name=godon-1-cluster --kubeconfig=/tmp/kind_kubeconfig.yaml
        kubectl cluster-info --kubeconfig=/tmp/kind_kubeconfig.yaml

    - name: List installed Helm releases
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üìã Listing all Helm releases..."
        helm list --all-namespaces || echo "No releases found"

    - name: Show current Godon resources
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üìä Showing current Godon resources..."
        echo "Namespaces:"
        kubectl get namespaces | grep godon || echo "No godon namespace found"
        echo ""
        echo "Pods in godon namespace:"
        kubectl get pods -n godon 2>/dev/null || echo "No pods found"
        echo ""
        echo "PVs/PVCs:"
        kubectl get pv,pvc -n godon 2>/dev/null || echo "No PVs/PVCs found"

    - name: Uninstall Godon chart
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üóëÔ∏è  Uninstalling Godon chart..."

        # Uninstall with --ignore-not-found to handle case where it's already gone
        helm uninstall godon -n godon --wait --ignore-not-found
        echo "‚úÖ Godon chart uninstall command completed"

    - name: Wait for pod termination
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "‚è≥ Waiting for pods to terminate..."
        kubectl wait --for=delete pod,job,deployment -l app.kubernetes.io/instance=godon -n godon --timeout=60s || true

        # Force delete any remaining jobs
        sleep 3
        REMAINING_JOBS=$(kubectl -n godon get jobs -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$REMAINING_JOBS" ]; then
          echo "‚ö†Ô∏è Found remaining jobs: $REMAINING_JOBS"
          kubectl -n godon delete jobs --all --force --grace-period=0 || true
        fi

        echo "‚úÖ All pods and jobs terminated"

    - name: Delete ALL PersistentVolumes for clean slate
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üóëÔ∏è Deleting ALL persistent volumes including Windmill database..."
        echo "This is necessary to fix Windmill database schema violations"
        kubectl -n godon delete pvc --all --force --grace-period=0 || true
        sleep 5

        # Double-check all PVCs are gone
        REMAINING_PVCS=$(kubectl -n godon get pvc --no-headers 2>/dev/null | wc -l)
        if [ "$REMAINING_PVCS" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $REMAINING_PVCS remaining PVCs, force deleting again..."
          kubectl -n godon delete pvc --all --force --grace-period=0 --timeout=10s || true
          sleep 3
        fi

        echo "‚úÖ All PVCs deleted including Windmill database"

    - name: Show remaining resources
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üìä Showing remaining resources after uninstall..."
        echo ""
        echo "Pods:"
        kubectl get pods -n godon 2>/dev/null || echo "No pods"
        echo ""
        echo "Services:"
        kubectl get services -n godon 2>/dev/null || echo "No services"
        echo ""
        echo "ConfigMaps:"
        kubectl get configmaps -n godon 2>/dev/null || echo "No configmaps"
        echo ""
        echo "Secrets:"
        kubectl get secrets -n godon 2>/dev/null || echo "No secrets"
        echo ""
        echo "PersistentVolumeClaims:"
        kubectl get pvc -n godon 2>/dev/null || echo "No PVCs"

    - name: Clean up namespace (if requested)
      if: github.event.inputs.keep_namespace != 'true'
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üßπ Deleting godon namespace..."
        kubectl delete namespace godon --timeout=60s || echo "‚ö†Ô∏è  Namespace deletion timed out or failed"

        # Wait for namespace deletion
        timeout=90
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if ! kubectl get namespace godon >/dev/null 2>&1; then
            echo "‚úÖ Namespace deleted successfully"
            break
          fi
          echo "Waiting for namespace deletion... ($elapsed/${timeout}s)"
          sleep 5
          elapsed=$((elapsed + 5))
        done

        if [ $elapsed -ge $timeout ]; then
          echo "‚ö†Ô∏è  Namespace deletion timed out (this is normal for PVs with finalizers)"
        fi

    - name: Clean up orphaned PVs
      if: github.event.inputs.keep_namespace != 'true'
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üßπ Checking for orphaned PersistentVolumes..."
        PV_LIST=$(kubectl get pv -o json | jq -r '.items[] | select(.spec.claimRef.namespace == "godon") | .metadata.name')
        if [ -n "$PV_LIST" ]; then
          echo "Found orphaned PVs:"
          echo "$PV_LIST"
          echo ""
          echo "Deleting orphaned PVs..."
          for pv in $PV_LIST; do
            echo "Deleting PV: $pv"
            kubectl delete pv "$pv" --timeout=30s || echo "‚ö†Ô∏è  Failed to delete PV $pv"
          done
        else
          echo "‚úÖ No orphaned PVs found"
        fi

    - name: Verify cleanup
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üîç Verifying cleanup..."
        echo ""
        echo "Namespaces:"
        kubectl get namespaces | grep godon && echo "‚ö†Ô∏è  godon namespace still exists" || echo "‚úÖ godon namespace removed"
        echo ""
        echo "Godon PVs:"
        kubectl get pv | grep godon && echo "‚ö†Ô∏è  godon PVs still exist" || echo "‚úÖ No godon PVs"
        echo ""
        echo "Godon releases:"
        helm list -n godon 2>/dev/null | grep godon && echo "‚ö†Ô∏è  godon release still exists" || echo "‚úÖ No godon releases"

    - name: Final cluster status
      if: always()
      env:
        KUBECONFIG: /tmp/kind_kubeconfig.yaml
      run: |
        echo "üìä Final cluster status..."
        echo ""
        echo "All namespaces:"
        kubectl get namespaces
        echo ""
        echo "All Helm releases:"
        helm list --all-namespaces || echo "No releases"
        echo ""
        echo "Cluster nodes:"
        kubectl get nodes
