name: "Godon Stack Status & Debug"

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Specific component to debug (empty = all)'
        required: false
        default: ''

jobs:
  stack_status:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verify KIND Cluster
        run: |
          echo "ðŸ” Verifying KIND cluster..."
          
          # Check if KIND cluster exists
          if ! kind get clusters | grep -q "godon-1-cluster"; then
            echo "âŒ KIND cluster 'godon-1-cluster' not found"
            echo "Available clusters:"
            kind get clusters
            echo ""
            echo "Please run the 'kind--setup-cluster' workflow first"
            exit 1
          fi
          
          echo "âœ… KIND cluster exists"
          
          # Export kubeconfig to known location
          kind export kubeconfig --name=godon-1-cluster --kubeconfig=/tmp/kind_kubeconfig.yaml
          
          # Verify connectivity
          kubectl cluster-info --kubeconfig=/tmp/kind_kubeconfig.yaml

      - name: Overall Stack Status
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "ðŸ” Godon Stack Status Analysis"
          echo "==============================="
          echo ""
          
          # Helm release status
          echo "ðŸ“Š Helm Release Status"
          helm status godon \
               --namespace godon \
               --show-resources || echo "âš ï¸  No Helm release found"
          
          echo ""
          echo "ðŸ¥ Pod Status"
          kubectl get pods -n godon -o wide
          
          echo ""
          echo "ðŸŒ Service Status"
          kubectl get services -n godon
          
          echo ""
          echo "ðŸ“¦ Deployments"
          kubectl get deployments -n godon
          
          echo ""
          echo "ðŸ’¾ Persistent Volumes"
          kubectl get pvc -n godon
          
          echo ""
          echo "ðŸŽ¯ Recent Events"
          kubectl get events -n godon \
            --sort-by='.lastTimestamp' | tail -20

      - name: Component Deep Dive
        if: inputs.component != ''
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          set -eEux
          component="${{ inputs.component }}"
          namespace="godon"
          
          echo "ðŸ”¬ Deep Dive: ${component}"
          echo "========================="
          echo ""
          
          # Find matching pods
          pods=$(kubectl get pods -n "${namespace}" \
            -o json | jq -r ".items[] | select(.metadata.name | contains(\"${component}\")) | .metadata.name")
          
          for pod in ${pods}; do
            echo "ðŸ“¦ Pod: ${pod}"
            echo "-------------------"
            
            # Pod details
            kubectl get pod "${pod}" -n "${namespace}" -o json
            
            echo ""
            echo "ðŸ“‹ Recent Logs (last 50 lines)"
            kubectl logs "${pod}" -n "${namespace}" --tail=50 \
              || echo "No logs available"
            
            echo ""
            echo "ðŸ”§ Pod Description"
            kubectl describe pod "${pod}" -n "${namespace}"
            
            echo ""
          done

      - name: Database Health Check
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "ðŸ’¾ Database Status"
          echo "=================="
          echo ""
          
          # Check YugaByte
          echo "ðŸ˜ YugaByteDB Status"
          kubectl get pods -n godon -l app=yugabytedb -o wide
          
          # Check Windmill DB  
          echo "ðŸŒŠ Windmill Database Status"
          kubectl get pods -n godon -l app=windmill -o wide
          
          echo ""
          echo "ðŸ’¾ PVC Status"
          kubectl get pvc -n godon \
            -o custom-columns=NAME:.metadata.name,STATUS:.status.phase,CAPACITY:.status.capacity.storage

      - name: Network Connectivity Check
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "ðŸŒ Network Connectivity"
          echo "======================="
          echo ""
          
          # Check endpoints
          echo "ðŸ”— Service Endpoints"
          kubectl get endpoints -n godon
          
          echo ""
          echo "ðŸŒ Ingress/Routes"
          kubectl get ingress -n godon \
            || echo "No ingress resources"
          
          echo ""
          echo "ðŸ”Œ Network Policies"
          kubectl get networkpolicy -n godon \
            || echo "No network policies"

      - name: Error Summary
        if: always()
        env:
          KUBECONFIG: /tmp/kind_kubeconfig.yaml
        run: |
          echo "ðŸš¨ Error Summary"
          echo "================"
          echo ""
          
          # Find non-running pods
          echo "âŒ Problem Pods:"
          kubectl get pods -n godon \
            -o json | jq -r '.items[] | select(.status.phase != "Running") | "\(.metadata.name): \(.status.phase)"' \
            || echo "All pods are running"
          
          echo ""
          echo "âš ï¸  Pods with Restarts:"
          kubectl get pods -n godon \
            -o json | jq -r '.items[] | select(.status.containerStatuses[0].restartCount > 0) | "\(.metadata.name): \(.status.containerStatuses[0].restartCount) restarts"' \
            || echo "No restarts"
          
          echo ""
          echo "ðŸ“‹ Failed Jobs/CronJobs:"
          kubectl get jobs -n godon \
            -o json | jq -r '.items[] | select(.status.failed > 0) | "\(.metadata.name): \(.status.failed) failures"' \
            || echo "No failed jobs"