---

########################################
## Component | Godon Seeder Job
########################################
godon_seeder:
  image:
    tag: "0.0.19"
  env:
  - name: CONTROLLER_VERSION
    value: "0.21.0"
  - name: BREEDER_VERSION
    value: "0.15.0"
  - name: WINDMILL_BASE_URL
    value: "http://windmill-app.godon.svc.cluster.local:8000/api"

########################################
## Component | Windmill Workflow Orchestration Engine
########################################
windmill:
  windmill:
    tag: "1.601.1"
    lspReplicas: 0
    workerGroups:
      # Controller workers - handle fast operations (preflight, breeder_create, etc)
      # Timeout hierarchy: Script-level > Worker group DEFAULT_TIMEOUT_SECONDS > Global default
      - name: "controller"
        replicas: 3
        extraEnv:
        - name: WORKER_GROUP
          value: "controller"
        - name: WORKER_TAGS
          value: "controller"
        - name: DEFAULT_TIMEOUT_SECONDS
          value: "120"  # 2 minutes - fast controller operations
        - name: WHITELIST_ENVS
          value: "GODON_API_SERVICE_PORT,GODON_METADATA_DB_SERVICE_PORT,YB_TSERVER_SERVICE_SERVICE_PORT,GODON_API_SERVICE_HOST,GODON_METADATA_DB_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_PORT_TCP_YSQL_PORT,GODON_ARCHIVE_DB_SERVICE_HOST,GODON_ARCHIVE_DB_SERVICE_PORT,GODON_ARCHIVE_DB_USER,GODON_ARCHIVE_DB_PASSWORD"
        - name: GODON_ARCHIVE_DB_SERVICE_HOST
          value: "yb-tservers.godon.svc.cluster.local"
        - name: GODON_ARCHIVE_DB_SERVICE_PORT
          value: "5433"
        - name: GODON_ARCHIVE_DB_USER
          value: "yugabyte"
        - name: GODON_ARCHIVE_DB_PASSWORD
          value: "yugabyte"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

      # Breeder workers - handle long-running breeder optimization jobs
      # No timeout - continuous workers with crash recovery via Optuna DB
      - name: "breeder"
        replicas: 5
        extraEnv:
        - name: WORKER_GROUP
          value: "breeder"
        - name: WORKER_TAGS
          value: "breeder"
        - name: WHITELIST_ENVS
          value: "GODON_API_SERVICE_PORT,GODON_METADATA_DB_SERVICE_PORT,YB_TSERVER_SERVICE_SERVICE_PORT,GODON_API_SERVICE_HOST,GODON_METADATA_DB_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_PORT_TCP_YSQL_PORT,GODON_ARCHIVE_DB_SERVICE_HOST,GODON_ARCHIVE_DB_SERVICE_PORT,GODON_ARCHIVE_DB_USER,GODON_ARCHIVE_DB_PASSWORD"
        - name: GODON_ARCHIVE_DB_SERVICE_HOST
          value: "yb-tservers.godon.svc.cluster.local"
        - name: GODON_ARCHIVE_DB_SERVICE_PORT
          value: "5433"
        - name: GODON_ARCHIVE_DB_USER
          value: "yugabyte"
        - name: GODON_ARCHIVE_DB_PASSWORD
          value: "yugabyte"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

      # Default workers - handle any job without a specific tag
      # Picks up dependency resolution, untagged scripts, and general operations
      - name: "default"
        replicas: 2
        extraEnv:
        - name: WORKER_GROUP
          value: "default"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "200m"
            memory: "256Mi"
  postgresql:
    image:
      repository: postgres
      tag: "14"

########################################
## Component | Godon API
########################################
api:
  image:
    repository: "ghcr.io/godon-dev/godon-api"
    tag: "0.0.17"
  env:
  - name: WINDMILL_BASE_URL
    value: "http://windmill-app.godon.svc.cluster.local:8000/api"

########################################
## Component | Knowledge Archive Database for Cooperating Config Breeders
########################################
archive-db:
  enabled: true
  # Skip disk I/O health checks for KIND environment (slow disk sync causes timeouts)
  # This skips only the /mnt/disk write/sync probes, keeps other monitoring
  Values:
    Services:
    - name: "yb-masters"
      skipHealthChecks: true
    - name: "yb-tservers"
      skipHealthChecks: true

########################################
## Component | Godon Metrics Exporter
########################################
metrics_exporter:
  env:
  - name: ARCHIVE_DB_HOST
    value: "yb-tservers.godon.svc.cluster.local:5433"
  - name: ARCHIVE_DB_USER
    value: "yugabyte"
  - name: ARCHIVE_DB_PW
    value: "yugabyte"
  - name: ARCHIVE_DB_DATABASE_NAME
    value: "archive_db"
