---

########################################
## CONFIG | Global Variables
########################################
#  global:
#    PROMETHEUS_URL: http//prometheus9090

########################################
## Network | Kubernetes Cluster Domain
########################################
clusterDomain: cluster.local

########################################
## Network | Godon DNS Domain
########################################
domainName: "cluster.local"

########################################
## Component | Godon Seeder Job
########################################
godon_seeder:
  enabled: true
  image:
    repository: ghcr.io/godon-dev/godon-seeder
    tag: 0.0.19
    pullPolicy: IfNotPresent
    pullSecret: ""
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  serviceAccountName: ""
  env:
  - name: WINDMILL_BASE_URL
    value: "http://windmill-app.godon.svc.cluster.local:8000/api"
  - name: CONTROLLER_VERSION
    value: "0.26.0"
  - name: BREEDER_VERSION
    value: "0.20.0"

########################################
## Component | Windmill Workflow Orchestration Engine
########################################
windmill:
  windmill:
    appReplicas: 1
    lspReplicas: 1
    workerGroups:
      # Controller workers - handle fast operations (preflight, breeder_create, etc)
      # Timeout hierarchy: Script-level > Worker group DEFAULT_TIMEOUT_SECONDS > Global default
      - name: "controller"
        replicas: 3
        extraEnv:
        - name: WORKER_GROUP
          value: "controller"
        - name: WORKER_TAGS
          value: "controller"
        - name: DEFAULT_TIMEOUT_SECONDS
          value: "120"  # 2 minutes - fast controller operations
        - name: GODON_ARCHIVE_DB_SERVICE_HOST
          value: "yb-tservers.godon.svc.cluster.local"
        - name: GODON_ARCHIVE_DB_SERVICE_PORT
          value: "5433"
        - name: GODON_ARCHIVE_DB_USER
          value: "yugabyte"
        - name: GODON_ARCHIVE_DB_PASSWORD
          value: "yugabyte"
        - name: WHITELIST_ENVS
          value: "GODON_API_SERVICE_PORT,GODON_METADATA_DB_SERVICE_PORT,YB_TSERVER_SERVICE_SERVICE_PORT,GODON_API_SERVICE_HOST,GODON_METADATA_DB_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_PORT_TCP_YSQL_PORT,GODON_ARCHIVE_DB_SERVICE_HOST,GODON_ARCHIVE_DB_SERVICE_PORT,GODON_ARCHIVE_DB_USER,GODON_ARCHIVE_DB_PASSWORD"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

      # Breeder workers - handle long-running breeder optimization jobs
      # No timeout - continuous workers with crash recovery via Optuna DB
      - name: "breeder"
        replicas: 5
        extraEnv:
        - name: WORKER_GROUP
          value: "breeder"
        - name: WORKER_TAGS
          value: "breeder"
        - name: GODON_ARCHIVE_DB_SERVICE_HOST
          value: "yb-tservers.godon.svc.cluster.local"
        - name: GODON_ARCHIVE_DB_SERVICE_PORT
          value: "5433"
        - name: GODON_ARCHIVE_DB_USER
          value: "yugabyte"
        - name: GODON_ARCHIVE_DB_PASSWORD
          value: "yugabyte"
        - name: WHITELIST_ENVS
          value: "GODON_API_SERVICE_PORT,GODON_METADATA_DB_SERVICE_PORT,YB_TSERVER_SERVICE_SERVICE_PORT,GODON_API_SERVICE_HOST,GODON_METADATA_DB_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_HOST,YB_TSERVER_SERVICE_SERVICE_PORT_TCP_YSQL_PORT,GODON_ARCHIVE_DB_SERVICE_HOST,GODON_ARCHIVE_DB_SERVICE_PORT,GODON_ARCHIVE_DB_USER,GODON_ARCHIVE_DB_PASSWORD"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

      # Default workers - handle any job without a specific tag
      # Picks up dependency resolution, untagged scripts, and general operations
      - name: "default"
        replicas: 2
        extraEnv:
        - name: WORKER_GROUP
          value: "default"
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

########################################
## Component | Godon Metrics Exporter
########################################
metrics_exporter:
  image:
    repository: "ghcr.io/godon-dev/godon-metrics-exporter"
    tag: "0.0.3"
    pullPolicy: IfNotPresent
    pullSecret: ""

  replicas: 1

  port: 9099

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  env:
  - name: PUSH_GATEWAY_URL
    value: "http://godon-pushgateway:9091"
  - name: PUSH_METRICS_ENABLED
    value: "true"

  livenessProbe:
    enabled: false

  podDisruptionBudget:
    enabled: false
    minAvailable: 1

  annotations: {}

  podLabels: {}

  serviceAccountName: ""

  volumes: []

  volumeMounts: []

########################################
## Component | Prometheus Push Gateway
########################################
pushgateway:
  enabled: true

  image:
    repository: prom/pushgateway
    tag: v1.9.0
    pullPolicy: IfNotPresent

  replicas: 1

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  service:
    type: ClusterIP
    port: 9091

  persistence:
    enabled: false
    size: 2Gi
    storageClass: ""

  # Optional service account
  serviceAccount:
    create: false

  # Pod disruption budget
  podDisruptionBudget:
    enabled: false
    minAvailable: 1

########################################
## Component | Godon API
########################################
api:
  image:
    repository: "ghcr.io/godon-dev/godon-api"
    tag: "0.0.18"
    pullPolicy: IfNotPresent
    pullSecret: ""

  replicas: 1

  port: 9090

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  env:
  - name: WINDMILL_BASE_URL
    value: "http://windmill-app.godon.svc.cluster.local:8000/api"

  livenessProbe:
    enabled: false

  podDisruptionBudget:
    enabled: false
    minAvailable: 1

  annotations: {}

  podLabels: {}

  serviceAccountName: ""

  volumes: []

  volumeMounts: []

########################################
## Component | Postgres Database Storing Godon Components Meta Data
########################################
metadata-db:
  image:
    repository: "postgres"
    tag: 13
    pullPolicy: IfNotPresent
  auth:
    username: meta_data
    password: meta_data
    database: meta_data

  # Increase resources for 10 concurrent workers (3 controller + 5 breeder + 2 default)
  # Increase max_connections for worker pool (default: 100)
  # Each worker opens multiple connections for job processing
  primary:
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
    initdb:
      args: "-E UTF8"
    extendedConf:
      max_connections: "200"
      shared_buffers: "128MB"
      effective_cache_size: "512MB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "2096kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"

########################################
## Component | Knowledge Archive Database for Cooperating Config Breeders
########################################
archive-db:

  enabled: false

  # Disable Load Balancer As Only used Internally
  enableLoadBalancer: false

  image:
    repository: "docker.io/yugabytedb/yugabyte"
    tag: 2.18.1.0-b84
    pullPolicy: IfNotPresent

  replicas:
    master: 1
    tserver: 1

  storage:
    ephemeral: false
    master:
      count: 1
      size: 1Gi
      storageClass: ""
    tserver:
      count: 1
      size: 20Gi
      storageClass: ""

  resource:
    master:
      requests:
        cpu: "1"
        memory: 1Gi
      limits:
        cpu: "2"
        memory: 2Gi
    tserver:
      requests:
        cpu: "0.2"
        memory: 200Mi
      limits:
        cpu: "2"
        memory: 2Gi

  master:
    extraEnv:
      - name: YSQL_DB
        value: archive_db
      - name: PUSH_GATEWAY_URL
        value: "http://godon-pushgateway:9091"
      - name: PUSH_METRICS_ENABLED
        value: "true"

  authCredentials:
    ysql:
      user: yugabyte
      password: yugabyte
      database: archive_db

  dnsPolicy: ClusterFirst
